# Adding a New Worker

## Files to Create

Create a new directory `<worker-name>/` with:

1. **`package.json`** - Standard npm package with scripts (devDependencies are inherited from monorepo root):
   - `build:types`: `wrangler types --env dev`
   - `deploy:calibration`: `wrangler deploy --env calibration`
   - `deploy:mainnet`: `wrangler deploy --env mainnet`
   - `start`: `wrangler dev --env dev` (see [D1 Database Access](#d1-database-access-optional) if database access is needed)
   - `test`: `vitest run` (see [D1 Database Access](#d1-database-access-optional) if database access is needed)

2. **`wrangler.toml`** - With three environments (top-level for tests, dev, calibration, mainnet). See [D1 Database Access](#d1-database-access-optional) if database access is needed.

3. **`vitest.config.ts`** (or `.js`) - Use `defineWorkersProject` from `@cloudflare/vitest-pool-workers/config`. See [D1 Database Access](#d1-database-access-optional) for loading migrations.

4. **`tsconfig.json`** - Extends `../tsconfig.base.json` (test files have separate config):

   ```json
   {
     "extends": "../tsconfig.base.json",
     "compilerOptions": {
       "composite": true,
       "outDir": "dist",
       "allowImportingTsExtensions": true
     },
     "include": ["src/**/*.ts", "*.d.ts"],
     "exclude": ["dist"]
   }
   ```

5. **`src/index.ts`** - Worker entry point using `satisfies ExportedHandler<Env>`

6. **`test/tsconfig.json`** - Separate TypeScript config for test files:

   ```json
   {
     "extends": "../tsconfig.json",
     "compilerOptions": {
       "types": ["@cloudflare/vitest-pool-workers"]
     },
     "include": ["**/*.ts"]
   }
   ```

7. **`test/index.test.ts`** - Tests importing worker with `.ts` extension

## Files to Update

1. **Root `package.json`** - Add worker to `workspaces` array
2. **Root `vitest.workspace.js`** - Add worker name to the array
3. Run `npm run update-ts-project` - Updates root `tsconfig.json` references
4. **`.github/workflows/ci.yml`** - Add deployment step in the `deploy` job

## Verification Steps

```bash
npm install
npm run build:types -w <worker-name>
npm test
```

Verify that the new worker appears in the test output as `@filbeam/<worker-name>`.

## TypeScript Worker Tips

- Use `satisfies ExportedHandler<Env>` for proper typing of handlers
- Import source files with `.ts` extension in tests
- The `worker-configuration.d.ts` is auto-generated by `wrangler types`
- Include `*.d.ts` in tsconfig to pick up generated types

## D1 Database Access (Optional)

If your worker needs access to the shared D1 database:

1. **Update `wrangler.toml`** - Copy D1 database IDs and bindings from an existing worker that uses D1 (e.g., `piece-retriever/wrangler.toml`)

2. **Update `package.json` scripts** to apply migrations:
   - `start`: `wrangler d1 migrations apply dev-db --local --cwd ../db && wrangler dev --env dev`
   - `test`: `wrangler d1 migrations apply test-db --local --cwd ../db && vitest run`

3. **Update `vitest.config.ts`** - Load migrations via `readD1Migrations` from `@cloudflare/vitest-pool-workers/config`

4. **Create `test/apply-migrations.ts`**:

   ```typescript
   import { applyD1Migrations, env } from 'cloudflare:test'
   await applyD1Migrations(env.DB, env.TEST_MIGRATIONS)
   ```

5. **Create `test/cloudflare-test.d.ts`** - Type declarations for test environment:

   ```typescript
   import type { D1Migration } from 'cloudflare:test'

   declare module 'cloudflare:test' {
     interface ProvidedEnv extends Cloudflare.Env {
       TEST_MIGRATIONS: D1Migration[]
     }
   }
   ```
